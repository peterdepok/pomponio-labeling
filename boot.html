<!DOCTYPE html>
<!--
  Kiosk boot screen: loaded by Chrome as a local file:// URL before
  Flask is ready. Polls /api/health every 500ms and redirects to
  http://localhost:8000 once the server responds. Shows a simple
  "Starting..." message so the operator knows the system is loading.

  This eliminates the ERR_CONNECTION_REFUSED problem: Chrome no longer
  tries to load localhost:8000 directly (which fails if Flask hasn't
  bound the port yet). Instead it loads this local file instantly,
  then navigates to Flask only after confirming it's alive.
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pomponio Ranch</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a1a;
    color: #e0e0e0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }
  .title {
    font-size: 42px;
    font-weight: 700;
    letter-spacing: 0.04em;
    margin-bottom: 24px;
    color: #ffffff;
  }
  .status {
    font-size: 24px;
    color: #80a0c0;
    margin-bottom: 40px;
  }
  .spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #1a1a3a;
    border-top: 5px solid #4080ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .error {
    color: #ff8080;
    font-size: 18px;
    margin-top: 24px;
    display: none;
    text-align: center;
    max-width: 600px;
  }
</style>
</head>
<body>
  <div class="title">Pomponio Ranch</div>
  <div class="status" id="status">Starting system...</div>
  <div class="spinner" id="spinner"></div>
  <div class="error" id="error"></div>

<script>
(function() {
  var TARGET = "http://localhost:8000";
  var HEALTH = TARGET + "/api/health";
  var POLL_MS = 500;
  var MAX_WAIT_S = 30;
  var statusEl = document.getElementById("status");
  var errorEl = document.getElementById("error");
  var startTime = Date.now();
  var attempts = 0;

  function poll() {
    attempts++;
    var elapsed = ((Date.now() - startTime) / 1000).toFixed(0);
    statusEl.textContent = "Connecting to server... (" + elapsed + "s)";

    var xhr = new XMLHttpRequest();
    xhr.open("GET", HEALTH, true);
    xhr.timeout = 2000;

    xhr.onload = function() {
      if (xhr.status >= 200 && xhr.status < 400) {
        statusEl.textContent = "Server ready. Loading app...";
        // Small delay so the operator sees the "ready" message
        setTimeout(function() {
          window.location.replace(TARGET);
        }, 300);
      } else {
        scheduleNext();
      }
    };

    xhr.onerror = function() { scheduleNext(); };
    xhr.ontimeout = function() { scheduleNext(); };
    xhr.send();
  }

  function scheduleNext() {
    var elapsed = (Date.now() - startTime) / 1000;
    if (elapsed > MAX_WAIT_S) {
      statusEl.textContent = "Server did not start";
      errorEl.style.display = "block";
      errorEl.textContent = "The system failed to start after " +
        MAX_WAIT_S + " seconds. Check kiosk.log for errors. " +
        "This page will keep trying...";
      // Keep polling even after "timeout" so it recovers if Flask starts late
    }
    setTimeout(poll, POLL_MS);
  }

  // Start polling immediately
  poll();
})();
</script>
</body>
</html>
